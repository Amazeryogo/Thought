{% extends "base.html" %}
{% block content %}
<style>
    .chat-wrapper {
        display: flex;
        flex-direction: column;
        height: 85vh;
        max-height: 85vh;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        background: #ffffff;
        color: #212529;
    }

    .chat-header {
        padding: 1rem;
        background-color: #f8f9fa;
        font-weight: bold;
        font-size: 1.2rem;
        border-bottom: 1px solid #ddd;
        color: #212529;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #ffffff;
    }

    .message {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.8rem;
        gap: 0.75rem;
    }

    .message.outgoing {
        flex-direction: row-reverse;
        text-align: right;
    }

    .message .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
    }

    .message-content {
        background-color: #f1f3f5;
        padding: 0.5rem 1rem;
        border-radius: 12px;
        max-width: 70%;
        word-wrap: break-word;
    }

    .message.outgoing .message-content {
        background-color: #dbeafe;
    }

    .message .sender {
        font-weight: bold;
        color: #0d6efd;
    }

    .chat-input {
        border-top: 1px solid #ddd;
        padding: 0.75rem;
        background-color: #f8f9fa;
    }

    .chat-input form {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input input[type="text"] {
        flex-grow: 1;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0.5rem 1rem;
        background-color: #ffffff;
        color: #212529;
    }

    .chat-input button {
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.2rem;
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
    }
</style>

<div class="container my-4">
    <div class="chat-wrapper" id="chat-box" data-username="{{ username }}" data-current-user="{{ current_user.username }}">
        <div class="chat-header">
            Chat with {{ username }}
        </div>

        <div class="chat-messages" id="messages">
        </div>

        <div class="chat-input">
            <form id="chat-form" method="post">
                <input type="text" id="message-input" name="message" placeholder="Type a message..." required>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
</div>
{{me
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    const chatBox = document.getElementById('chat-box');
    const username = chatBox.dataset.username;
    const currentUser = chatBox.dataset.currentUser;
    const messagesContainer = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message-input');

    function gravatar(email) {
        const hash = CryptoJS.MD5(email.trim().toLowerCase()).toString();
        return `https://www.gravatar.com/avatar/${hash}?d=identicon&s=64`;
    }

    function appendMessage(msg) {
        const div = document.createElement('div');
        div.classList.add('message');

        const avatar = document.createElement('img');
        avatar.src = gravatar(msg.sender.email || `${msg.sender}@gmail.com`);
        avatar.classList.add('avatar');

        const content = document.createElement('div');
        content.classList.add('message-content');
        content.innerHTML = `<span class="sender">${msg.sender}</span><br>${msg.message}`;

        if (msg.sender === currentUser) {
            div.classList.add('outgoing');
        }

        div.appendChild(avatar);
        div.appendChild(content);

        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    async function fetchMessages() {
        const res = await fetch(`/api/messages?with=${username}`);
        const data = await res.json();
        messagesContainer.innerHTML = '';  // Clear old messages
        data.forEach(appendMessage);
    }
    async function sendMessage(content) {
        const res = await fetch(`/api/send_message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, message: content })
        });
        if (res.ok) {
            input.value = '';
            fetchMessages();
        }
    }
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const msg = input.value.trim();
        if (msg !== '') sendMessage(msg);
    });
    setInterval(fetchMessages, 1000);
    fetchMessages();
</script>

{% endblock %}