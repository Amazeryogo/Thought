{% extends "base.html" %}
{% block content %}

<div class="container my-4">
    <div class="chat-wrapper" id="chat-box" data-username="{{ username }}" data-current-user="{{ current_user.username }}">
        <div class="chat-header">
            <a href="/{{username}}">{{ username }}</a>
        </div>

        <div class="chat-messages" id="messages">
        </div>

        <div class="chat-input">
            <form id="chat-form" method="post">
                <input type="text" id="message-input" name="message" placeholder="Type a message..." required>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    const chatBox = document.getElementById('chat-box');
    const username = chatBox.dataset.username;
    const currentUser = chatBox.dataset.currentUser;
    const messagesContainer = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message-input');

    function gravatar(email) {
        const hash = CryptoJS.MD5(email.trim().toLowerCase()).toString();
        return `https://www.gravatar.com/avatar/${hash}?d=identicon&s=64`;
    }

    function appendMessage(msg) {
        const div = document.createElement('div');
        div.classList.add('message');

        const avatar = document.createElement('img');
        avatar.src = gravatar(msg.sender.email || `${msg.sender}@gmail.com`);
        avatar.classList.add('avatar');

        const content = document.createElement('div');
        content.classList.add('message-content');
        content.innerHTML = `<span class="sender">${msg.sender}</span><br>${msg.message}`;

        if (msg.sender === currentUser) {
            div.classList.add('outgoing');
        }

        div.appendChild(avatar);
        div.appendChild(content);

        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    async function fetchMessages() {
        const res = await fetch(`/api/messages?with=${username}`);
        const data = await res.json();
        messagesContainer.innerHTML = '';  // Clear old messages
        data.forEach(appendMessage);
    }
    async function sendMessage(content) {
        const res = await fetch(`/api/send_message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, message: content })
        });
        if (res.ok) {
            input.value = '';
            fetchMessages();
        }
    }
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const msg = input.value.trim();
        if (msg !== '') sendMessage(msg);
    });
    setInterval(fetchMessages, 1000);
    fetchMessages();
</script>

{% endblock %}