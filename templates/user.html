{% extends "base.html" %}

{% block content %}
<h1 style="text-align: center; font-family: 'Abril Fatface', cursive;">{{ user.username }}</h1>
<div class="container py-5">
    <div class="row justify-content-center align-items-center">
        <div class="col-md-9 col-lg-7 col-xl-5">
            <div class="card rounded-3">
                <div class="card-body p-4">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <img src="{{ avatar }}" alt="Profile Photo" class="img-fluid profile-photo">
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-4">{{ user.aboutme }}</p>
                            <p class="mb-1"><strong>Followers:</strong> <span id="followerCount">{{ user.get_followers_number() }}</span></p>
                            <p class="mb-4"><strong>Following:</strong> {{ user.get_following_number() }}</p>
                                {% if current_user.username != user.username %}
                                    <div class="d-flex justify-content-start mt-3">
                                        <button id="followBtn"
                                                class="btn {{ 'btn-danger' if current_user.username in user.followers else 'btn-primary' }}"
                                                data-following="{{ 'true' if current_user.username in user.followers else 'false' }}"
                                                data-username="{{ user.username }}">
                                            {{ 'Unfollow' if current_user.username in user.followers else 'Follow' }}
                                        </button>
                                    </div>
                                {% endif %}
                        </div>
                    </div>
                    {% if user.username == current_user.username %}
                        <span class="material-symbols-outlined" onclick="location.href='/set/aboutme'" style="cursor: pointer;">manage_accounts</span>
                    {% else %}
                        <span class="material-symbols-outlined" onclick="location.href='/message/{{ user.username }}'" style="cursor: pointer;">forum</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% for post in posts %}
    {% include '_post.html' %}
{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const followBtn = document.getElementById("followBtn");
    if (!followBtn) return;

    followBtn.addEventListener("click", function () {
        const username = followBtn.getAttribute("data-username");

        fetch(`/follow/${username}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                followBtn.textContent = data.is_following ? "Unfollow" : "Follow";
                followBtn.classList.toggle("btn-danger", data.is_following);
                followBtn.classList.toggle("btn-primary", !data.is_following);
                document.getElementById("followerCount").textContent = data.follower_count;
            } else {
                alert(data.message || "Action failed");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Something went wrong.");
        });
    });
});
</script>
<hr class="my-5">

<div class="container">
    <h3 class="text-center mb-4" style="font-family: 'Roboto Slab', serif;">ðŸ“¸ Gallery</h3>

    {% if user_images %}
    <div class="row g-3">
        {% for img in user_images %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm">
                <img src="{{ url_for('render_image', userid=user._id, imageuid=img) }}" class="card-img-top img-fluid rounded" alt="User Upload">
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-muted">No images uploaded yet.</p>
    {% endif %}
</div>

{% endblock %}
